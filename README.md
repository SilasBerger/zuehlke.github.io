# Zuehlke Github.io
The source code for the [zuehlke.github.io](http://zuehlke.github.io/) page.

## Usage
### Branches
The default branch is `development`. All changes should be made via pull requests into that branch. The `gh-pages`
branch contains only the build, which is served on [zuehlke.github.io](http://zuehlke.github.io/). A build and
re-deployment is automatically triggered on every push to the `develop` branch (see "Deployment and Automation" below).
The `master` branch contains the last build of the old application, which is no longer being served.

**In summary:**
- `development`: default branch, pushes to this branch trigger a build and re-deployment
- `gh-pages`: deployed branch containing the static web page
- `master`: no longer in use, contains the latest build of the old website

### Development
**Web application**
- Run `npm install` to install all dependencies
- Run `npm start` to open the app in a local development server ([http://localhost:3000/](http://localhost:3000/))
- Run `npm run build` to create a production build in the `build` directory
- Run `npm run test` to run all tests (no tests defined at the moment)

**Automation**
- In `.github/actions/data-update`, run `pip install -r requiremets.txt`, preferably in a `virtualenv` environment
- To execute the script, run `INPUT_GITHUB_PAT=<PAT_PUBLIC> INPUT_DATA_DIR=<some_dir> python src/main.py`

where

- `PAT_PUBLIC` is a public-access-only GitHub PAT (see _Resources_)
- `some_dir` is the absolute path to the desired data output directory (usually, the `src/data` subdirectory of a clone
  of this repository)

To avoid unnecessary GitHub Actions workflow runs, it is recommended to not commit directly to the `develop` branch,
but rather work with pull requests instead. Alternatively, disable the `[push] Build and Deploy` workflow in the
_Actions_ tab during development. Keep in mind though that this will also stop data updates (contributions, people) from
being automatically merged into the production branch. Both workflows can also be manually triggered in the _Actions_
tab (preferably on the `develop` branch).

## Frontend Structure
The frontend is written in React + TypeScript and is managed through
[create-react-app](https://www.npmjs.com/package/create-react-app). It has the following pages:
- `Contributions`: All public repositories owned by the Zühlke organization. 
- `People`: All non-concealed members of the Zuehlke organization. This may include Zühlke alumni who are still actively
  contributing to Zuehlke repositories. Organization membership is managed by Ben Millo.
  
The data for these two pages are loaded client-side from `src/data/contributions.json` and `src/data/people.json`
respectively. These files are automatically generated by the `data-update` GitHub action (see _Data Update Automation_)
and contain publicly available data fetched from the GitHub API, such as a repository's name, description and stargazer
count, and a person's GitHub name, full name, bio and avatar.

The website is mobile-responsive and its design approximates that of the
[Zühlke corporate page](https://www.zuehlke.com/en).

Hero image source: GettyImages stock photo from
[https://zuehlke.templafy.com/images/stock-images?search=code](https://zuehlke.templafy.com/images/stock-images?search=code).

## Deployment and Automation
### GitHub Pages
[GitHub Pages](https://pages.github.com/) is a feature offered by GitHub which allows every user or organization to
serve the contents of one repository as a static website. The name of that repository has to be
`<user_or_org>.github.io`, which will also be the default URL for the resulting web page. In our case, this is
`zuehlke.github.io`, and [http://zuehlke.github.io/#/main/contributions](http://zuehlke.github.io/#/main/contributions)
respectively.

In the settings for a GitHub Pages repository, we can specify the branch which should be served as the website. In our
case, the branch to be served is set to `gh_pages`. It therefore needs to contain the built, static website content,
rather than any source code. A GitHub Actions workflow is set up to automatically build the application on every push
to the `develop` branch and commit the results to the `gh_pages` branch (see _CI/CD_).

### CI/CD
On every push to the `develop` branch, the `[push] Build and Deploy` GitHub Actions workflow is triggered, which is
defined in [.github/workflows/build-and-deploy.yml](.github/workflows/build-and-deploy.yml). This workflow checks out
the `develop` branch, builds the application using `npm run build` and commits the contents of the `build` directory
to the `gh-pages` branch.

The `secrets.GITHUB_TOKEN` value used in the `build_and_deploy` job's final step is a special environment variable
automatically provided to every GitHub Actions workflow. This token grants the workflow full permissions on the
repository it is running for.

### Data Update Automation (Workflow)
- scheduled job once a day fetches latest people and contributors from API and creates an auto-commit into the
  develop branch (which triggers another re-deploy). At the core of this workflow is a custom GitHub action (see below).
- scheduled job always operates (i.e. takes action source from and pushes to) default branch (here: develop)
- often significantly delayed (up to 30 minutes is realistic)
- data and last update in src/data

### Data Update Automation (Custom Action)
- dockerized python script (Python doesn't run natively on GH actions)
- any branch settings here?
- settings in consts
- discuss action.yml
- why an action vs. azure
- Overall architecture
- Expectations for data coming from GitHub API (only showing non-concealed members (althoug that should theoretically be
different, according to the API specs), alumni are still members, etc.)

### Resources
- **Bot user**: A GitHub user with read and write permissions to this repository
- **PAT_PUBLIC**: A _GitHub Personal Access Token_ (PAT) owned by the bot user's account and created with the full `repo`
  scope. PATs can be created on GitHub under `Settings -> Developer settings -> Personal access tokens`.
- **PAT_REPO**: TBA

### Limitations
- costs in minutes (currently around 2.5 for the udpate + 1.5 for the build)
- scheduled workflows may get deactivated (would need to use external trigger then)
  
## Improvements and Additional Features
### Frontend
- **Consider using Zühlke font for H2 headings, use slightly weaker gray.**
- Show stargazers / forks / watchers counts on contribution tiles
- Allow curated inputs
  - In an additional JSON file, we can add repo IDs which should be crawled even if they are not owned by the Zühlke org
    (showcase (potentially private) contributions by Zühlke employees)
  - Same for people
  - Non-Zühlke repos
  - Blacklist repos and people (e.g. avoid dummy repos, bot users or people who don't want to be featured on the
  website)
- Is there a way to connect people and repos? Maybe we could click on a person and only get their repos? Note: this
  would require requesting contributor IDs for every repo. For large projects, this could mean having to fetch a large
  number of pages (current limit: 100 results per request).
- Full-text search, filters, sorting

### Automation
- Migrate to JavaScript
  - We currently spend about 1 minute per run on a Docker build
  - Regular GitHub Action environment provides everything we need, except for a Python runtime: if we use JavaScript, we don't need Docker anymore
  - When not using Docker, make sure to commit all `node_modules` - there is no `npm intall` step. Be careful not to accidentally `.gitignore` some file or directory in the `node_modules` (e.g. some `dist` dir).
- Implement commit / push logic, rather than using a third-party action (for security and to reduce dependencies)
  - Big parts of the logic already exist in Python, up until commit `???`
  - Note: That code is not up-to-date with the current setup and architecture, many concepts have changed (context, config file, workdir / source dir, etc.)
  - Need a way to either use a GitHub PAT for pushing, or pass an SSH key into the action
- Consider other deployment strategies
  - (Container App or something)
  - Azure Function
  - Azure Web App on an F1 or B1 tier App Service Plan (need to either not use Docker, or also pay for a container registry)
  
## Doc TODO
- set retry to 0, because it will wait for rate limit lifting, which costs GitHub action minutes
- Show screenshots for token creation (public-only and full private repo access)
- show screenshots for secrets

## Integration Instructions
This section is only relevant for integrating the current forked branch into the mainline repository and can be removed
afterwards. To integrate the revitalization, the following steps are required:

